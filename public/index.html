<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Diabetes prediction application using machine learning to assess diabetes risk based on health metrics">
    <title>Diabetes Prediction System</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
</head>
<body>
    <div class="container">
        <h1>Diabetes Prediction System</h1>
        <p>Enter your health data to predict diabetes risk</p>
        
        <div class="error-message" id="error-message" style="display: none;">
            <p id="error-text"></p>
        </div>
        
        <form id="prediction-form">
            <div class="input-group">
                <label for="pregnancies">Pregnancies</label>
                <input type="number" id="pregnancies" name="pregnancies" required min="0" max="20" step="1" value="0">
                <span class="info">Number of pregnancies</span>
            </div>
            
            <div class="input-group">
                <label for="glucose">Glucose Level</label>
                <input type="number" id="glucose" name="glucose" required min="0" max="300" value="100">
                <span class="info">Plasma glucose concentration (mg/dL)</span>
            </div>
            
            <div class="input-group">
                <label for="blood_pressure">Blood Pressure</label>
                <input type="number" id="blood_pressure" name="blood_pressure" required min="0" max="200" value="70">
                <span class="info">Diastolic blood pressure (mm Hg)</span>
            </div>
            
            <div class="input-group">
                <label for="skin_thickness">Skin Thickness</label>
                <input type="number" id="skin_thickness" name="skin_thickness" required min="0" max="100" value="20">
                <span class="info">Triceps skinfold thickness (mm)</span>
            </div>
            
            <div class="input-group">
                <label for="insulin">Insulin Level</label>
                <input type="number" id="insulin" name="insulin" required min="0" max="900" value="80">
                <span class="info">2-Hour serum insulin (mu U/ml)</span>
            </div>
            
            <div class="input-group">
                <label for="bmi">BMI</label>
                <input type="number" id="bmi" name="bmi" required min="10" max="70" step="0.1" value="25.0">
                <span class="info">Body mass index (weight in kg/(height in m)Â²)</span>
            </div>
            
            <div class="input-group">
                <label for="diabetes_pedigree">Diabetes Pedigree Function</label>
                <input type="number" id="diabetes_pedigree" name="diabetes_pedigree" required min="0" max="3" step="0.01" value="0.5">
                <span class="info">Diabetes pedigree function (genetic influence)</span>
            </div>
            
            <div class="input-group">
                <label for="age">Age</label>
                <input type="number" id="age" name="age" required min="0" max="120" step="1" value="30">
                <span class="info">Age in years</span>
            </div>
            
            <button type="submit" class="predict-btn">Predict</button>
        </form>
    </div>

    <script>
        // Wait for the page to load
        document.addEventListener('DOMContentLoaded', function() {
            // Get the form element
            const form = document.getElementById('prediction-form');
            
            // Add submit event listener
            form.addEventListener('submit', async function(event) {
                // Prevent the default form submission
                event.preventDefault();
                
                try {
                    // Get form values
                    const pregnancies = parseFloat(document.getElementById('pregnancies').value);
                    const glucose = parseFloat(document.getElementById('glucose').value);
                    const bloodPressure = parseFloat(document.getElementById('blood_pressure').value);
                    const skinThickness = parseFloat(document.getElementById('skin_thickness').value);
                    const insulin = parseFloat(document.getElementById('insulin').value);
                    const bmi = parseFloat(document.getElementById('bmi').value);
                    const diabetesPedigree = parseFloat(document.getElementById('diabetes_pedigree').value);
                    const age = parseFloat(document.getElementById('age').value);
                    
                    // Create input features array
                    const features = [
                        pregnancies,
                        glucose,
                        bloodPressure,
                        skinThickness,
                        insulin,
                        bmi,
                        diabetesPedigree,
                        age
                    ];
                    
                    // Make prediction using the pre-trained model
                    makePrediction(features);
                } catch (error) {
                    showError('Error processing form: ' + error.message);
                }
            });
            
            // Function to show error message
            function showError(message) {
                const errorElement = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                errorText.textContent = message;
                errorElement.style.display = 'block';
            }
            
            // Function to make prediction
            async function makePrediction(features) {
                try {
                    // Load the pre-trained model
                    const model = await tf.loadLayersModel('/model/model.json');
                    
                    // Normalize the features (same scaling as used during training)
                    // These values are approximations based on the Pima Indians Diabetes Dataset
                    const means = [3.8, 120.9, 69.1, 20.5, 79.8, 32.0, 0.47, 33.2];
                    const stds = [3.4, 32.0, 19.4, 16.0, 115.2, 7.9, 0.3, 11.8];
                    
                    const normalizedFeatures = features.map((value, index) => {
                        return (value - means[index]) / stds[index];
                    });
                    
                    // Make prediction
                    const tensor = tf.tensor2d([normalizedFeatures]);
                    const prediction = model.predict(tensor);
                    const probabilityTensor = prediction.dataSync()[0];
                    const probability = Math.round(probabilityTensor * 100);
                    const result = probabilityTensor >= 0.5 ? 'Positive' : 'Negative';
                    
                    // Create result object
                    const resultObj = {
                        prediction: result,
                        probability: probability,
                        features: {
                            'Pregnancies': features[0],
                            'Glucose': features[1],
                            'Blood Pressure': features[2],
                            'Skin Thickness': features[3],
                            'Insulin': features[4],
                            'BMI': features[5],
                            'Diabetes Pedigree Function': features[6],
                            'Age': features[7]
                        }
                    };
                    
                    // Show result
                    showResult(resultObj);
                } catch (error) {
                    // If model loading fails, use the fallback prediction
                    console.error('Error loading model:', error);
                    fallbackPrediction(features);
                }
            }
            
            // Fallback prediction function using a simple logistic regression
            function fallbackPrediction(features) {
                // These coefficients approximate a logistic regression model trained on the Pima dataset
                const coefficients = [0.12, 0.02, -0.01, 0.001, 0.0001, 0.08, 0.9, 0.04, -5.0]; // Last one is intercept
                
                // Calculate logistic regression
                let logit = coefficients[8]; // Intercept
                for (let i = 0; i < features.length; i++) {
                    logit += features[i] * coefficients[i];
                }
                
                // Apply sigmoid function
                const probability = 1 / (1 + Math.exp(-logit));
                const result = probability >= 0.5 ? 'Positive' : 'Negative';
                const probabilityPercent = Math.round(probability * 100);
                
                // Create result object
                const resultObj = {
                    prediction: result,
                    probability: probabilityPercent,
                    features: {
                        'Pregnancies': features[0],
                        'Glucose': features[1],
                        'Blood Pressure': features[2],
                        'Skin Thickness': features[3],
                        'Insulin': features[4],
                        'BMI': features[5],
                        'Diabetes Pedigree Function': features[6],
                        'Age': features[7]
                    }
                };
                
                // Show result
                showResult(resultObj);
            }
            
            // Function to show the result
            function showResult(result) {
                // Create a result HTML page
                const resultHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                    <meta name="description" content="Diabetes prediction results based on your health metrics">
                    <title>Diabetes Prediction Result</title>
                    <link rel="stylesheet" href="/static/styles.css">
                    <link rel="preconnect" href="https://fonts.googleapis.com">
                    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                </head>
                <body>
                    <div class="container">
                        <h1>Diabetes Prediction Result</h1>
                        
                        <div class="result-container ${result.prediction === 'Positive' ? 'positive' : 'negative'}">
                            <h2>Prediction: <span>${result.prediction}</span></h2>
                            <p class="probability">Probability: <span>${result.probability}%</span></p>
                        </div>
                        
                        <div class="features-summary">
                            <h3>Input Features:</h3>
                            <table>
                                <tr>
                                    <th>Feature</th>
                                    <th>Value</th>
                                </tr>
                                ${Object.entries(result.features).map(([feature, value]) => `
                                <tr>
                                    <td>${feature}</td>
                                    <td>${value}</td>
                                </tr>
                                `).join('')}
                            </table>
                        </div>
                        
                        <div class="disclaimer">
                            <p><strong>Note:</strong> This prediction is based on a machine learning model and should not be considered as a medical diagnosis. Please consult with a healthcare professional for proper medical advice.</p>
                        </div>
                        
                        <a href="/" class="back-btn">Make Another Prediction</a>
                    </div>
                </body>
                </html>
                `;
                
                // Replace the current document with the result HTML
                document.open();
                document.write(resultHtml);
                document.close();
            }
        });
    </script>
</body>
</html>
